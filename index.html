<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Interactive AR Demo</title>
  <!-- Подключаем A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f0f0f0;
    }
    #start-ar {
      padding: 15px 30px;
      font-size: 18px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: block;
    }
    #start-ar:hover {
      background: #0056b3;
    }
    #ar-scene {
      display: none;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>
<body>
  <!-- Кнопка для запуска AR -->
  <button id="start-ar">Start AR</button>

  <!-- AR-сцена -->
  <a-scene
    id="ar-scene"
    embedded
    xr-mode-ui="enabled: false"
    webxr="optionalFeatures: hit-test, local-floor;">
    
    <!-- Ретикл для выбора поверхности -->
    <a-entity
      id="reticle"
      position="0 0 -1"
      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
      material="color: white; shader: flat"
      visible="false">
    </a-entity>

    <!-- 3D-объект: куб -->
    <a-box
      id="ar-object"
      position="0 0 0"
      material="color: blue"
      scale="0.2 0.2 0.2"
      animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"
      visible="false">
    </a-box>

    <!-- Камера -->
    <a-camera
      id="camera"
      position="0 1.6 0"
      look-controls="enabled: false">
    </a-camera>
  </a-scene>

  <script>
    // Получаем элементы
    const startButton = document.getElementById('start-ar');
    const scene = document.getElementById('ar-scene');
    const reticle = document.getElementById('reticle');
    const arObject = document.getElementById('ar-object');

    // Проверка поддержки WebXR
    startButton.addEventListener('click', async () => {
      if (navigator.xr) {
        try {
          // Запрашиваем AR-сессию
          const session = await navigator.xr.requestSession('immersive-ar', {
            optionalFeatures: ['hit-test', 'local-floor']
          });

          // Показываем сцену
          startButton.style.display = 'none';
          scene.style.display = 'block';

          // Инициализация WebXR для A-Frame
          scene.setAttribute('webxr', 'session: ' + session);

          // Настройка hit-test для поиска поверхностей
          let hitTestSource = null;
          session.addEventListener('select', () => {
            if (reticle.getAttribute('visible') && !arObject.getAttribute('visible')) {
              // Устанавливаем позицию куба на месте ретикля
              const position = reticle.getAttribute('position');
              arObject.setAttribute('position', position);
              arObject.setAttribute('visible', 'true');
            }
          });

          // Запрашиваем источник hit-test
          const viewerSpace = await session.requestReferenceSpace('viewer');
          hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

          // Обновление ретикля на каждом кадре
          session.addEventListener('end', () => {
            scene.style.display = 'none';
            startButton.style.display = 'block';
          });

          function onXRFrame(t, frame) {
            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(scene.renderer.xr.getReferenceSpace());
              if (pose) {
                const matrix = pose.transform.matrix;
                reticle.setAttribute('visible', 'true');
                reticle.setAttribute('position', {
                  x: matrix[12],
                  y: matrix[13],
                  z: matrix[14]
                });
              } else {
                reticle.setAttribute('visible', 'false');
              }
            } else {
              reticle.setAttribute('visible', 'false');
            }
            session.requestAnimationFrame(onXRFrame);
          }
          session.requestAnimationFrame(onXRFrame);
        } catch (error) {
          alert('Failed to start AR: ' + error.message);
        }
      } else {
        alert('WebXR not supported on this device.');
      }
    });
  </script>
</body>
</html>